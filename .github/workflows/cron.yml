name: Cron Run Draw Calculator CLI
on:
  schedule:
    - cron: "* * * * *" # everyday at 2pm

jobs:
  runCLI:
    name: Run CLI if necessary

    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 1
      matrix:
        node: ["16.9.0"]
        os: [ubuntu-latest]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Use Node ${{ matrix.node }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      - name: Install deps and build (with cache)
        uses: bahmutov/npm-install@v1

      - name: Run Draw Calculator CLI if required
        id: runDrawCalcCLI
        env:
          ALCHEMY_MAINNET_URL: ${{secrets.ALCHEMY_MAINNET_URL}}
          ALCHEMY_RINKEBY_URL: ${{secrets.ALCHEMY_RINKEBY_URL}}
          MATICVIGIL_URL: ${{secrets.MATICVIGIL_URL}}
          MUMBAI_URL: ${{secrets.MUMBAI_URL}}
          DEBUG: ${{secrets.DEBUG}}
        run: |
          node ./scripts/runCli.js
          echo  ${{steps.runDrawCalcCLI.outputs.polygonCliToolRan}} ${{steps.runDrawCalcCLI.outputs.mainnetDrawId}} ${{steps.runDrawCalcCLI.outputs.mainnetChainId}}
          echo  ${{steps.runDrawCalcCLI.outputs.mainnetCliToolRan}} ${{steps.runDrawCalcCLI.outputs.polygonDrawId}} ${{steps.runDrawCalcCLI.outputs.polygonChainId}}

      - name: Commit files for polygon
        if: ${{ steps.runDrawCalcCLI.outputs.polygonCliToolRan == "true" }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull
          git add .
          git commit -m "Add draw for polygon draw ${{steps.runDrawCalcCLI.outputs.polygonDrawId}}"

     - name: Commit files for mainnet
        if: ${{ steps.runDrawCalcCLI.outputs.mainnetCliToolRan == "true" }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull
          git add .
          git commit -m "Add draw for polygon draw ${{steps.runDrawCalcCLI.outputs.mainnetDrawId}}"

    #   - name: Push changes
    #     uses: ad-m/github-push-action@master
    #     if: ${{ steps.runDrawCalcCLI.outputs.polygonCliToolRan == "true" }} # this could be either polygonCliToolRan or mainnetCliToolRan
    #     with:
    #       github_token: ${{ secrets.GITHUB_TOKEN }}
    #       branch: ${{ github.ref }}
